# Nginx配置文件 - 用于解决CORS跨域问题并代理API请求

# 必要的events配置块
events {
    worker_connections  1024;
}

# 主配置块
http {
    # 配置服务器块
    server {
        listen 8080;  # Nginx监听端口
        server_name localhost;

        # 前端静态文件配置 - 支持WebSocket
        location / {
            proxy_pass http://localhost:3001;  # 代理到Vite开发服务器
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket支持配置
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Origin "http://localhost:3001";
        }

        # API代理配置 - 解决CORS问题
        location /api/ {
            proxy_pass http://localhost:8000/;  # 代理到后端API服务
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # CORS配置 - 关键部分
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
            add_header Access-Control-Allow-Headers 'Origin, X-Requested-With, Content-Type, Accept, Authorization';
            add_header Access-Control-Max-Age 86400;
            
            # 处理预检请求
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }
        
        # 错误页面配置
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root html;
        }
    }
}

# 配置说明：
# 1. 这个配置将把所有请求通过nginx代理，解决CORS跨域问题
# 2. 静态文件请求(/)会被代理到Vite开发服务器(3001端口)
# 3. API请求(/api/)会被代理到后端服务(8000端口)并添加CORS头
# 4. 使用时需要确保nginx已安装并运行此配置文件